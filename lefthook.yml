pre-commit:
  parallel: true  # Run commands in parallel for speed
  
  commands:
    # Format and lint staged files with Biome
    biome-fix:
      glob: "*.{js,ts,jsx,tsx,json,jsonc}"
      run: |
        # First, try to fix what can be fixed automatically (including unsafe fixes)
        yarn biome check --write --unsafe {staged_files} || true
        # Then check for any remaining issues (warnings or errors)
        output=$(yarn biome check {staged_files} 2>&1)
        exit_code=$?
        # Check if output contains warnings or errors
        if echo "$output" | grep -qE "Found [0-9]+ (warning|error|warnings|errors)"; then
          echo "❌ Biome found warnings or errors. Please fix them before committing."
          echo "$output"
          exit 1
        fi
        # Also fail if Biome itself failed (exit code != 0)
        if [ $exit_code -ne 0 ]; then
          echo "❌ Biome check failed."
          echo "$output"
          exit 1
        fi
      stage_fixed: true  # Re-stage files after fixing
    
    # Prevent committing to main/master
    protect-branches:
      run: |
        branch=$(git rev-parse --abbrev-ref HEAD)
        if [ "$branch" = "main" ] || [ "$branch" = "master" ]; then
          echo "❌ Direct commits to $branch are not allowed"
          exit 1
        fi